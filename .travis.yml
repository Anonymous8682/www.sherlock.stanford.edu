# ----------------------------------------------------------------------------
#
# config
#
# ----------------------------------------------------------------------------

sudo: false
language: python

# we only care about the docs branch
branches:
    only:
        - docs

# notify srcc#github
notifications:
    slack:
        secure: ErfaD2eZV8I2ZYIascqS+41iOd44e6YLoIRCOXqruISLXYQqo1M8nJJvV6mYFKmQLE64RsBDrHkhZxaPM5h0uLj7kTNnb0Hk4Hb8xsEBOueB01gdoXUZHfxn/pVPrLjZLAvqHn8XxojEyzq0wVPlvBNcnJw3nATpsO3ZXjuOcdzKzzNsMqAwt/p5MmT7j7dBCOIs2J5EEmgDoxPyoejxyTn1SDOn3i9packcA+DWx3upIgePBhuaFJWEq8+9QyDPb5yMrjQQYH14shRVTh5bloHpN8OuuUfWIVo6vd6Odqysa076CPQ6858y2anH3H+C58lKgfaIO0K8cyBwO9W4eZPl3iJ2pUvMNGisedGz9Y6FX7kQ9J11vHquTTG60UT3JivOcMz7lBxWs4qVXaa40qmzpPKWwzGvfoW7uFjuGjJjkrNvFcLHHHOX7/jA9RfGZnk/iFjiAIYZ0XlqxsHJj0qgvm2/jKDr24ijFnE6/kz6OXMkrjK5Q2+FGDSLjq01B+KFLxvOgIj4apzvJtpIbYS9zRNmjjcHmz3YON3+PjqRFsip+/RDfATick274C0c5pyge8gE7rkZGGSvIYwjxeFYZaR5fH1teSBjA3utTVi8GtR1F5P58KPpmSoATMB7W3pTUcS7RCyGsbnws6ZhWmTPgjcMm6EkAXuVyqkpS2Y=


# ----------------------------------------------------------------------------
#
# build
#
# ----------------------------------------------------------------------------

# limit clone depth to 50, to speed up build
git:
    depth: 50

before_install:
    - |
      # check that we actually need to build anything
      if [ "$TRAVIS_PULL_REQUEST" != "false" ]; then
          TRAVIS_COMMIT_RANGE="FETCH_HEAD...$TRAVIS_BRANCH"
      fi
      git diff --name-only $TRAVIS_COMMIT_RANGE | grep -qvE '(README.md)|(INTERNALS.md)|(LICENSE)|(^(\.git|site))/' || {
          echo "Only non-source files were updated, no need to trigger a build."
          exit
      }

# install dependencies
install:
    - pip install mkdocs
    - pip install -r requirements.txt

# build
script:
    - mkdocs build --verbose --clean

# ----------------------------------------------------------------------------
#
# deployment
#
# ----------------------------------------------------------------------------

# deploy
#   fetch "docs" branch and copy contents of material/ there, then commit and push

deploy:
    provider: pages
    skip_cleanup: true
    github-token: $DEPLOY_KEY # Set in travis-ci.com dashboard
    local-dir: site
    target_branch: gh-pages   # that's the default, but just to make sure
    fqdn: www.sherlock.stanford.edu
    #fqdn: 117f8628f187c24bbe15febead3046fa.sherlock.stanford.edu # temporary stealthy URL
    project-name: "Sherlock documentation"
    on:
        branch: docs
    verbose: true
    edge:
        branch: v1.8.47
